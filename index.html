<!DOCTYPE html>
<html lang="en">
<head>
<title>ML Storm Viewer</title>
</head>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.11.1.min.js"></script>
<script>
    let grid, grid_cells, mode_probs, ml_models, modes, mode_colors;

    async function init()
    {
        ml_models = ["CNN_1", "SS", "DNN_1"];
        modes = ["Supercell", "QLCS", "Disorganized"];
        mode_colors = ["Reds", "Blues", "Greens"];
        grid = await d3.json("NCEP_211_staggered_polygons.json");
        grid_cells = [];
        for (let i=0; i<grid.features.length; i++)
        {
            grid.features[i].id = String(i);
            grid_cells[i] = String(i);
        }
        console.log(grid);
        mode_probs = {};
        for (let model_i=0; model_i < ml_models.length; model_i++) {
            for (let mode_j = 0; mode_j < modes.length; mode_j++) {
                let col_name = ml_models[model_i] + "_" + modes[mode_j];
                mode_probs[col_name] = [];
            }
        }
        await d3.csv("label_probabilities_201605100000_fh_24.csv",
            function(row) {
                for (let model_i=0; model_i < ml_models.length; model_i++) {
                    for (let mode_j=0; mode_j < modes.length; mode_j++) {
                        let col_name = ml_models[model_i] + "_" + modes[mode_j] + "_nprob";
                        mode_probs[ml_models[model_i] + "_" + modes[mode_j]].push(parseFloat(row[col_name]));
                    }
                }
            });
        console.log(mode_probs);
        load_date();
    }
    async function load_date()
    {
        let selected_probs = {};
        let selected_index = {};
        plot_data = [];
        for (let model_i=0; model_i < ml_models.length; model_i++) {
            for (let mode_j = 0; mode_j < modes.length; mode_j++) {
                let col_name = ml_models[model_i] + "_" + modes[mode_j];
                selected_probs[col_name] = [];
                selected_index[col_name] = grid_cells.filter(function(v) {return mode_probs[col_name][v] >= 0.02});
                selected_index[col_name].forEach(function(s) {
                    selected_probs[col_name].push(mode_probs[col_name][s]);
                });
                plot_data.push({type: "choroplethmapbox", name: col_name, geojson: grid,
            featureidkey: "id", locations: selected_index[col_name],
            z: selected_probs[col_name], zmin: 0, zmax: 0.5, colorscale: mode_colors[mode_j],
            marker: {line: {color: "white", width:0.5}, opacity: 0.2}})
            }
        }
        layout = {
        width: 1000,
        height: 700,
        margin: {t: 50, l: 20, b: 20, r: 20},
        title: "Storm Mode",
        mapbox: {
            center: {lon: -96, lat: 40},
            zoom: 4,
            style: "open-street-map",
            }
    };
        Plotly.react(document.getElementById("mapview"), plot_data, layout);
    }
</script>

<body onload="init()">
<div id="mapview">
</div>

</body>
</html>
